---
title: Validation Report
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: html_document
params:
  manifest: NA
  individual: NA
  indiv_template: "animal"
  biospecimen: NA
  assay: NA
  assay_name: "rnaSeq"
---

```{r knitr-setup, include = FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE,
  results = "asis",
  error = TRUE
)
library("dccvalidator")

report <- function(...) {
  cat(..., "\n\n", sep = "\n\n")
}

report_if <- function(condition, ...) {
  if (condition) {
    report(...)
  }
}

```

## Column names

Metadata files are expected to contain certain columns. If any are missing, they will be reported below.

```{r check-column-names}
manifest_cols <- check_cols_manifest(params$manifest)
indiv_cols <- check_cols_individual(params$individual, params$indiv_template)
biosp_cols <- check_cols_biospecimen(params$biospecimen)
assay_cols <- check_cols_assay(params$assay, params$assay_name)

report_if(
  !identical(manifest_cols, character(0)),
  "The following columns are missing from the manifest: ",
  paste(manifest_cols, collapse = ", ")
)
report_if(
  !identical(indiv_cols, character(0)),
  "The following columns are missing from the individual metadata: ",
  paste(indiv_cols, collapse = ", ")
)
report_if(
  !identical(biosp_cols, character(0)),
  "The following columns are missing from the biospecimen metadata: ",
  paste(biosp_cols, collapse = ", ")
)
report_if(
  !identical(assay_cols, character(0)),
  "The following columns are missing from the assay metadata: ",
  paste(assay_cols, collapse = ", ")
)
```

## Individual IDs

Individual and biospecimen metadata files should contain an `specimenID` column,
and individual IDs should match between these files.

```{r eval-compare-individual-ids}
eval_individual <- "individualID" %in% names(params$individual) & "individualID" %in% names(params$biospecimen)
```

```{r missing-indivID-col, eval = !eval_individual}
report("The individual and/or biospecimen metadata file is missing an `individualID` column.")
```

```{r compare-individual-ids, eval = eval_individual}
indiv_comparison <- check_indiv_ids(params$individual, params$biospecimen)

report_if(
  length(indiv_comparison$missing_from_x) > 0,
  "The following individual IDs are missing from the individual metadata file. This should be fixed:\n",
  paste(indiv_comparison$missing_from_x, collapse = ", ")
)

report_if(
  length(indiv_comparison$missing_from_y) > 0,
  "The following individual IDs are missing from the biospecimen metadata file. This may need to be fixed:\n",
  paste(indiv_comparison$missing_from_y, collapse = ", ")
)

report_if(
  length(indiv_comparison$missing_from_x) == 0 &
    length(indiv_comparison$missing_from_y) == 0,
  "**All good!** No mismatched individual IDs found."
)
```

## Specimen IDs

Biospecimen and assay metadata files should contain a `specimenID` column, and
specimen IDs should match between these files.

```{r eval-compare-specimen-ids}
eval_specimen <- "specimenID" %in% names(params$biospecimen) & "specimenID" %in% names(params$assay)
```

```{r missing-specimenID-col, eval = !eval_specimen}
report("The individual and/or biospecimen metadata file is missing a `specimenID` column.")
```

```{r compare-specimen-ids, eval = eval_individual}
specimen_comparison <- check_specimen_ids(params$biospecimen, params$assay)

report_if(
  length(specimen_comparison$missing_from_x) > 0,
  "The following specimen IDs are missing from the biospecimen metadata file. This should be fixed:\n",
  paste(specimen_comparison$missing_from_x, collapse = ", ")
)

report_if(
  length(specimen_comparison$missing_from_y) > 0,
  "The following specimen IDs are missing from the assay metadata file. This may need to be fixed:\n",
  paste(specimen_comparison$missing_from_y, collapse = ", ")
)

report_if(
  length(specimen_comparison$missing_from_x) == 0 &
    length(specimen_comparison$missing_from_y) == 0,
  "**All good!** No mismatched specimen IDs found."
)
```
